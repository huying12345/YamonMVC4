
//------------------------------------------------------------------------------
// <auto-generated>
//     此代码由亚萌智能表单代码生成工具生成。
//
//     对此文件的更改可能会导致不正确的行为，并且如果
//     重新生成代码，这些更改将会丢失。除非此项目不再使用代码生成器生成。
//     如果想修改此文件的方法，请在此文件的上级目录中的VOrderDetailController重写(override)该方法。
//     如有问题联系zongeasy@qq.com
//
//</auto-generated>
//------------------------------------------------------------------------------

using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Data;
using System.Collections;
using System.IO;
using System.Linq.Expressions;
using System.Web;
using System.Web.Mvc;
using Yamon.Framework.DAL;
using Yamon.Module.SiteManage.Entity;
using Yamon.Module.Product.Entity;
using Yamon.Module.Product.DAL;
using Newtonsoft.Json;
using Yamon.Framework.Common;
using Yamon.Module.SiteManage.DAL;
using Yamon.Module.UCenter.DAL;
using Yamon.Framework.Common.IO;
using Yamon.Framework.MVC;
using Yamon.Module.Common;
using Yamon.Framework.NPOI;




namespace Yamon.Module.Product.WebApi
{
    /// <summary>
    /// 订单明细视图
    /// </summary>
    public partial class _VOrderDetailController :BaseController
    {

        public VOrderDetailDAL dal = new VOrderDetailDAL();

        public virtual ActionResult Grid1_Models()
        {
             return GridByFilterID("VOrderDetail_Models");
        } 
        public virtual ActionResult Grid1()
        {
             return GridByFilterID("");
        } 
        

        [NonAction]        
        public  virtual List<VOrderDetail> GetGridList(string filterId, int showValue, out int totalRows)
        {
            totalRows = 0;
            string sort = RequestHelper.NameValue.GetString("sort").Replace("_ShowValue","");
            string order = RequestHelper.NameValue.GetString("order");
            int page = RequestHelper.NameValue.GetInt("page");
            int rows = RequestHelper.NameValue.GetInt("rows", 20);
            if (string.IsNullOrEmpty(sort))
            {
                sort = "OrderDetailID";
            }
            if (string.IsNullOrEmpty(order))
            {
                order = "desc";
            }
            string orderby = sort + " " + order;
            List<VOrderDetail> modelList = new List<VOrderDetail>();
            switch(filterId)
            {
                    case "VOrderDetail_Models":
                    {
                      modelList = dal.GetEntityListByPage_Models(out totalRows,0,page,rows,orderby);
                      break;
                    }

                default:
                    {
                    modelList = dal.GetEntityListByPage(out totalRows,0,page,rows,orderby);
                    break;
                    }
            }
            if (showValue == 0)
            {
                return modelList;
            }
            return  modelList.Select(model => dal.GetModelGridShowValue(model)).ToList();
        }
        [NonAction]
        public  virtual ActionResult GridByFilterID(string filterId)
        {
            filterId = string.IsNullOrEmpty(filterId)?"":filterId;
            try
            {
                int totalRows = 0;
                filterId = string.IsNullOrEmpty(filterId) ? "" : filterId;
                hash["rows"] = GetGridList(filterId, 1, out totalRows);
                hash["total"] = totalRows;
                hash["success"] = true;
            }
            catch (Exception ex)
            {
                hash["success"] = false;
                hash["message"] = ex.Message;
                hash["rows"] = new List<VOrderDetail>();
            }
            return Content(JsonConvert.SerializeObject(hash)); 
        }
   
    [LogFilter]
    public virtual ActionResult BatchDelete()
    {
        string ids = StringHelper.UrlDecode(RequestHelper.GetRequestString("ids"));
        int result = dal.BatchDeleteByID(ids);
        Hashtable hash = new Hashtable();
        hash["success"] = result > 0;
        hash["message"] = "";
        return Json(hash);
    }

    [LogFilter]
    public virtual ActionResult Delete(string id)
    {
        int result = dal.DeleteByID(id);
        hash["success"] = result > 0;
        hash["message"] = "";
        return Json(hash);
    }

        public  virtual ActionResult ExportToExcel(string filterId = "", int showAllField = 1, int showValue = 1)
        {
            try
            {
               int totalRows = 0;
                List<VOrderDetail> list = GetGridList(filterId, showValue, out totalRows);
                DataTable modelList = list.ToDataTable();
                modelList = ControllerHelper.ToExcelDataTable(modelList, showValue);
                string[] fields = {"OrderDetailID","OrderID","ProductNo","ProductName","TypeName","Price","Num","SalePrice","TotalMoney","MemberID","Status","Models","PayStatus","CreateTime","PayType","CreateUserID"};
                for (int i = 0; i < fields.Length; i++)
                {
                    modelList.Columns[fields[i]].SetOrdinal(i);
                }
                ArrayList delFieldList = new ArrayList();
                for (int i = 0; i < modelList.Columns.Count; i++)
                {
                    if (!fields.Contains(modelList.Columns[i].ColumnName))
                    {
                        delFieldList.Add(modelList.Columns[i].ColumnName);
                    }
                    else
                    {
                        modelList.Columns[i].ColumnName = dal.GetDisplayName(modelList.Columns[i].ColumnName);
                    }
                }
                foreach (string s in delFieldList)
                {
                    modelList.Columns.Remove(s);
                }
                ExcelHelper.ExportXlsToDownload(modelList, "VOrderDetail.xls");
            }
            catch (Exception ex)
            {
                hash["success"] = false;
                hash["message"] = ex.Message;
            }
            return Content(JsonConvert.SerializeObject(hash));
        }
        [CheckPurview(pageCode:"Product_VOrderDetail_Show")]        
        public ActionResult GetEntityByID(string id)
        {
            VOrderDetail model = dal.GetModelByID(id);
            if (model != null)
            {
                hash["data"] = model;
                hash["success"] = true;
            }
            return Content(JsonConvert.SerializeObject(hash));
        }

        [CheckPurview(pageCode:"Product_VOrderDetail_Show")]
        public ActionResult GetInfoByID(string id)
        {
            VOrderDetail model = dal.GetModelByID(id);
            if (model != null)
            {
                model = dal.GetModelShowValue(model);
                hash["success"] = true;
                hash["data"] = model;
            }
           return Content(JsonConvert.SerializeObject(hash));
        }

        [CheckPurview(pageCode:"Product_VOrderDetail_Show")]
        public ActionResult GetModelByID(string id)
        {
            VOrderDetail model = dal.GetModelByID(id);
            if (model != null)
            {
                model = dal.GetModelShowValue(model,true);
                hash["data"] = model;
                hash["success"] = true;
                string json = JsonConvert.SerializeObject(hash);
                json=json.Replace("_ShowValue\":","\":");
                return Content(json);
            }
            return Content(JsonConvert.SerializeObject(hash));
        }




    }
}
